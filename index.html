<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1ÂàÜ„Ç¥„É´„Éï„Ç≥„Éº„ÉÅ</title>
    <meta name="description" content="ÊÇ©„Åø„Çí1ÂàÜ„ÅßËß£Ê±∫ÔºÅ„Ç∑„Éã„Ç¢Âêë„Åë„Ç¥„É´„Éï„Ç¢„Éâ„Éê„Ç§„Çπ„ÉÑ„Éº„É´">
    <meta name="theme-color" content="#2E7D32">
    <style>
        /* --- Base & Reset --- */
        :root {
            --primary-color: #2E7D32; /* Golf Green */
            --accent-color: #FF8F00; /* Warm Orange */
            --text-color: #333333;
            --bg-color: #F9F9F9;
            --card-bg: #FFFFFF;
            --border-color: #DDDDDD;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --font-main: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            --step-inactive: #E0E0E0;
            
            /* Font Sizes (Default Medium) */
            --fs-base: 18px;
            --fs-h1: 20px;
            --fs-h2: 22px;
            --fs-btn: 20px;
        }

        /* Font Size Variants */
        [data-fontsize="large"] {
            --fs-base: 22px;
            --fs-h1: 24px;
            --fs-h2: 26px;
            --fs-btn: 24px;
        }
        [data-fontsize="extra"] {
            --fs-base: 26px;
            --fs-h1: 26px; /* Header constrains */
            --fs-h2: 30px;
            --fs-btn: 28px;
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --primary-color: #66BB6A;
            --accent-color: #FFA726;
            --text-color: #EEEEEE;
            --bg-color: #121212;
            --card-bg: #1E1E1E;
            --border-color: #444444;
            --step-inactive: #444444;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            font-size: var(--fs-base);
            transition: background-color 0.3s, color 0.3s, font-size 0.2s;
        }

        /* --- Layout Container --- */
        #app {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--bg-color);
            position: relative;
            padding-bottom: 100px; /* Space for footer/fab */
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        /* --- Header --- */
        header {
            background-color: var(--card-bg);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: var(--fs-h1);
            margin: 0;
            color: var(--primary-color);
            font-weight: bold;
            cursor: pointer; /* „ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Å´Ë¶ã„Åõ„Çã */
        }

        .header-controls {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            background: none;
            border: none; /* Remove border for cleaner look */
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            padding: 0;
        }
        
        /* --- Progress Bar --- */
        .progress-container {
            padding: 10px 16px;
            background: var(--card-bg);
            margin-bottom: 10px;
        }
        .progress-bar {
            display: flex;
            justify-content: space-between;
            position: relative;
        }
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--step-inactive);
            z-index: 0;
            transform: translateY(-50%);
        }
        .step-indicator {
            width: 30px;
            height: 30px;
            background: var(--step-inactive);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #fff;
            position: relative;
            z-index: 1;
            font-weight: bold;
        }
        .step-indicator.active {
            background: var(--primary-color);
        }
        .step-indicator.completed {
            background: var(--primary-color);
        }

        /* --- Main Content --- */
        main {
            padding: 16px;
        }

        h2 {
            font-size: var(--fs-h2);
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            display: inline-block;
            width: 100%;
        }

        .card-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .btn-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s, border-color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 110px;
            box-shadow: var(--shadow);
        }

        .btn-card:active {
            transform: scale(0.98);
            background-color: var(--step-inactive);
        }

        .btn-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(46, 125, 50, 0.1);
        }

        .btn-icon {
            font-size: 36px;
            margin-bottom: 8px;
            display: block;
        }

        .btn-label {
            font-size: var(--fs-base);
            font-weight: bold;
            color: var(--text-color);
            line-height: 1.3;
        }

        /* --- Form Elements --- */
        .form-group {
            margin-bottom: 24px;
        }
        .form-label {
            font-size: var(--fs-base);
            font-weight: bold;
            margin-bottom: 12px;
            display: block;
            color: var(--primary-color);
        }
        .radio-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .radio-btn {
            flex: 1;
            min-width: 90px;
        }
        .radio-input {
            display: none;
        }
        .radio-label {
            display: block;
            padding: 14px;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
        }
        .radio-input:checked + .radio-label {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }

        /* Input Controls */
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-group {
            flex: 1;
        }
        .input-group label {
            display: block;
            font-size: 14px; /* Label stays small */
            margin-bottom: 4px;
            color: var(--text-color);
            font-weight: bold;
        }
        .simple-input, .simple-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: var(--fs-base);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: inherit;
            appearance: none;
        }
        /* Custom arrow for select */
        .simple-select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }
        [data-theme="dark"] .simple-select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23EEEEEE' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        }

        .btn-next {
            width: 100%;
            padding: 18px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: var(--fs-btn);
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* --- Result --- */
        .result-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            border-top: 6px solid var(--accent-color);
        }

        .prescription-title {
            font-size: var(--fs-h2);
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .cause-section {
            background-color: rgba(0,0,0,0.03);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .section-header {
            font-size: var(--fs-base);
            font-weight: bold;
            margin: 16px 0 8px 0;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 4px;
        }

        .todo-list, .routine-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .todo-item {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
        }
        .todo-checkbox {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            margin-top: 4px;
            flex-shrink: 0;
            accent-color: var(--primary-color);
        }
        
        .ng-box {
            background-color: #FFEBEE;
            border-left: 5px solid #F44336;
            padding: 12px;
            border-radius: 4px;
            color: #B71C1C;
            font-weight: bold;
        }
        [data-theme="dark"] .ng-box {
            background-color: #3E2723;
            color: #FFCDD2;
        }

        .routine-item {
            margin-bottom: 10px;
            font-size: var(--fs-base);
        }
        .routine-number {
            display: inline-block;
            width: 26px;
            height: 26px;
            background: var(--text-color);
            color: var(--bg-color);
            border-radius: 50%;
            text-align: center;
            line-height: 26px;
            font-size: 16px;
            margin-right: 8px;
        }

        .memo-area {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: var(--fs-base);
            font-family: inherit;
            margin-top: 10px;
            background-color: var(--bg-color);
            color: var(--text-color);
            resize: vertical;
        }

        .btn-save {
            width: 100%;
            padding: 14px;
            background-color: var(--text-color); /* Neutral for save */
            color: var(--bg-color);
            border: none;
            border-radius: 8px;
            font-size: var(--fs-base);
            font-weight: bold;
            margin-top: 12px;
            cursor: pointer;
        }
        
        .btn-line {
            width: 100%;
            padding: 14px;
            background-color: #06C755; /* LINE Green */
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: var(--fs-base);
            font-weight: bold;
            margin-top: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* --- Footer & FAB --- */
        footer {
            margin-top: 40px;
            text-align: center;
            padding-bottom: 40px;
        }
        
        .btn-link {
            background: none;
            border: none;
            color: var(--text-color);
            text-decoration: underline;
            font-size: 16px;
            margin: 0 10px;
            cursor: pointer;
            padding: 10px;
        }

        .fab-emergency {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #D32F2F;
            color: white;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 150;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        .fab-label {
            position: absolute;
            bottom: -20px;
            font-size: 12px;
            font-weight: bold;
            color: #D32F2F;
            background: rgba(255,255,255,0.9);
            padding: 2px 4px;
            border-radius: 4px;
            white-space: nowrap;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }
        .modal.open {
            display: flex;
        }
        .modal-content {
            background: var(--card-bg);
            width: 90%;
            max-width: 400px;
            max-height: 85vh;
            border-radius: 12px;
            padding: 24px;
            overflow-y: auto;
            position: relative;
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 32px;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 0 10px;
            line-height: 1;
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: bold;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
            margin-bottom: 16px;
            color: var(--primary-color);
        }

        /* Settings Styles */
        .settings-section {
            margin-bottom: 24px;
        }
        .settings-label {
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
        }
        .size-btns {
            display: flex;
            gap: 8px;
        }
        .size-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            border-radius: 6px;
            cursor: pointer;
        }
        .size-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .theme-switch-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        .settings-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background: var(--bg-color);
            color: var(--text-color);
            margin-bottom: 8px;
        }
        .settings-note {
            font-size: 12px;
            color: #888;
        }

        /* Help Styles */
        .help-list {
            list-style: none;
            padding: 0;
        }
        .help-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .help-icon {
            font-size: 28px;
            margin-right: 12px;
            min-width: 40px;
            text-align: center;
        }
        .help-text h4 {
            margin: 0 0 4px 0;
            font-size: 18px;
            color: var(--primary-color);
        }
        .help-text p {
            margin: 0;
            font-size: 15px;
            color: var(--text-color);
        }

        /* History & Emergency shared styles */
        .history-item {
            border-bottom: 1px solid var(--border-color);
            padding: 16px 0;
            cursor: pointer;
        }
        .history-meta {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #888;
            margin-bottom: 6px;
        }
        .history-place {
            font-weight: bold;
            color: var(--accent-color);
            background: rgba(255, 143, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        .history-title {
            font-weight: bold;
            font-size: var(--fs-base);
            line-height: 1.4;
        }
        
        .emergency-list {
            list-style: none;
            padding: 0;
        }
        .emergency-list li {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
        }
        .emergency-list li:hover {
            background-color: rgba(0,0,0,0.05);
        }

        /* Utils */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-in; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body>

<div id="app">
    <!-- Header -->
    <header>
        <h1 onclick="app.reset()" title="„Éà„ÉÉ„Éó„Å∏Êàª„Çã">1ÂàÜ„Ç¥„É´„Éï„Ç≥„Éº„ÉÅ</h1>
        <div class="header-controls">
            <button class="icon-btn" onclick="app.showModal('helpModal')" aria-label="‰Ωø„ÅÑÊñπ">‚ùì</button>
            <button class="icon-btn" onclick="app.showModal('settingsModal')" aria-label="Ë®≠ÂÆö">‚öôÔ∏è</button>
        </div>
    </header>

    <!-- Progress -->
    <div class="progress-container">
        <div class="progress-bar">
            <div class="step-indicator active" id="step1-ind">1</div>
            <div class="step-indicator" id="step2-ind">2</div>
            <div class="step-indicator" id="step3-ind">3</div>
        </div>
    </div>

    <!-- Main Content -->
    <main>
        <!-- Step 1: ÊÇ©„ÅøÈÅ∏Êäû -->
        <div id="step1" class="step-content fade-in">
            <h2>‰ªä„ÅÆÊÇ©„Åø„ÅØÔºü</h2>
            <div class="card-grid" id="problemGrid">
                <!-- JS„ÅßÁîüÊàê -->
            </div>
        </div>

        <!-- Step 2: Áä∂Ê≥ÅÈÅ∏Êäû -->
        <div id="step2" class="step-content hidden fade-in">
            <h2>Áä∂Ê≥Å„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ</h2>
            
            <div class="form-group">
                <span class="form-label">‰ΩøÁî®„ÇØ„É©„Éñ</span>
                <div class="radio-group">
                    <div class="radio-btn">
                        <input type="radio" name="club" id="club-driver" value="driver" class="radio-input" checked>
                        <label for="club-driver" class="radio-label">1W</label>
                    </div>
                    <div class="radio-btn">
                        <input type="radio" name="club" id="club-wood" value="wood" class="radio-input">
                        <label for="club-wood" class="radio-label">FW/UT</label>
                    </div>
                    <div class="radio-btn">
                        <input type="radio" name="club" id="club-iron" value="iron" class="radio-input">
                        <label for="club-iron" class="radio-label">„Ç¢„Ç§„Ç¢„É≥</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <span class="form-label">ÁèæÂú®„ÅÆÂ†¥ÊâÄ</span>
                <div class="radio-group">
                    <div class="radio-btn">
                        <input type="radio" name="scene" id="scene-range" value="range" class="radio-input" checked>
                        <label for="scene-range" class="radio-label">Á∑¥ÁøíÂ†¥</label>
                    </div>
                    <div class="radio-btn">
                        <input type="radio" name="scene" id="scene-course" value="course" class="radio-input">
                        <label for="scene-course" class="radio-label">„É©„Ç¶„É≥„Éâ</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <span class="form-label">„ÅÑ„Å§„ÇÇ„ÅÆÁêÉÁ≠ã</span>
                <div class="radio-group">
                    <div class="radio-btn">
                        <input type="radio" name="trend" id="trend-slice" value="slice" class="radio-input" checked>
                        <label for="trend-slice" class="radio-label">Âè≥Á≥ª</label>
                    </div>
                    <div class="radio-btn">
                        <input type="radio" name="trend" id="trend-hook" value="hook" class="radio-input">
                        <label for="trend-hook" class="radio-label">Â∑¶Á≥ª</label>
                    </div>
                </div>
            </div>

            <button class="btn-next" onclick="app.goToStep(3)">Ë®∫Êñ≠„Åô„Çã</button>
            <button class="btn-link" style="width:100%; margin-top:10px;" onclick="app.goToStep(1)">Êàª„Çã</button>
        </div>

        <!-- Step 3: ÁµêÊûú -->
        <div id="step3" class="step-content hidden fade-in">
            <h2>„Ç≥„Éº„ÉÅ„Åã„Çâ„ÅÆÂá¶ÊñπÁÆã</h2>
            
            <div id="resultContainer">
                <!-- JS„ÅßÊ≥®ÂÖ• -->
            </div>

            <div class="result-card">
                <span class="section-header">‰∏äÈÅîË®òÈå≤ÔºàÂ±•Ê≠¥„Å´ÊÆã„ÅôÔºâ</span>
                
                <div class="input-row">
                    <div class="input-group">
                        <label for="recordDate">„ÅÑ„Å§</label>
                        <input type="date" id="recordDate" class="simple-input">
                    </div>
                    <div class="input-group">
                        <label for="recordPlaceSelect">„Å©„Åì„Åß</label>
                        <select id="recordPlaceSelect" class="simple-select">
                            <option value="Á∑¥ÁøíÂ†¥">Á∑¥ÁøíÂ†¥</option>
                            <option value="„Ç≥„Éº„Çπ">„Ç≥„Éº„Çπ</option>
                            <option value="Ëá™ÂÆÖ">Ëá™ÂÆÖ</option>
                            <option value="„É¨„ÉÉ„Çπ„É≥">„É¨„ÉÉ„Çπ„É≥</option>
                            <option value="other">„Åù„ÅÆ‰ªñ (ÊâãÂÖ•Âäõ)</option>
                        </select>
                        <input type="text" id="recordPlaceInput" class="simple-input hidden" placeholder="Â†¥ÊâÄ„ÇíÂÖ•Âäõ" style="margin-top:6px;">
                    </div>
                </div>

                <label for="userMemo" style="display:block; font-size:14px; font-weight:bold; margin-bottom:4px; color:var(--text-color);">Ê∞ó‰ªò„Åç„Éª„É°„É¢</label>
                <textarea class="memo-area" id="userMemo" rows="3" placeholder="Êâì„Å£„ÅüÊÑüËß¶„ÇÑ„Çπ„Ç≥„Ç¢„Å™„Å©..."></textarea>
                
                <button class="btn-save" onclick="app.saveResult()">üìñ Â±•Ê≠¥„Å´‰øùÂ≠ò„Åô„Çã</button>
                <button class="btn-line" onclick="app.shareLine()">üí¨ LINE„ÅßÈÄÅ„Çã</button>
            </div>

            <button class="btn-next" style="background-color: var(--step-inactive); color: var(--text-color);" onclick="app.reset()">ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åô</button>
        </div>
    </main>

    <footer>
        <button class="btn-link" onclick="app.toggleHistory()">üìú ÈÅéÂéª„ÅÆÂ±•Ê≠¥„ÇíË¶ã„Çã</button>
    </footer>

    <!-- Emergency FAB -->
    <div class="fab-emergency" onclick="app.showModal('emergencyModal')">
        üÜò
        <span class="fab-label">„ÅäÂä©„Åë</span>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="app.closeModal('historyModal')">√ó</button>
            <div class="modal-header">‰øùÂ≠ò„Åó„ÅüÂ±•Ê≠¥</div>
            <div id="historyList">
                <p style="text-align:center; color:#888;">Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
            </div>
            <button class="btn-link" onclick="app.clearHistory()" style="color:#d32f2f; width:100%; margin-top:20px;">Â±•Ê≠¥„ÇíÂÖ®Ê∂àÂéª</button>
        </div>
    </div>

    <!-- Emergency Modal -->
    <div id="emergencyModal" class="modal">
        <div class="modal-content" style="background-color: #FFF3E0;">
            <button class="close-modal" onclick="app.closeModal('emergencyModal')">√ó</button>
            <h2 style="color:#D84315; border-bottom:none;">Á∑äÊÄ•ÔºÅ„ÉØ„É≥„Éù„Ç§„É≥„Éà</h2>
            <p>‰ªä„ÅÆÁä∂Ê≥Å„Å´Ëøë„ÅÑ„ÇÇ„ÅÆ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
            <ul class="emergency-list">
                <li onclick="alert('„ÄêÊ∑±ÂëºÂê∏„Äë\n\n1. Á©∫„ÇíË¶ã‰∏ä„Åí„Å¶Èºª„Åã„ÇâÂ§ß„Åç„ÅèÂê∏„ÅÜ\n2. Âè£„Åã„Çâ„ÇÜ„Å£„Åè„ÇäÂêê„Åè\n\n„Åæ„Åö„ÅØËêΩ„Å°ÁùÄ„Åç„Åæ„Åó„Çá„ÅÜ„ÄÇ')">üíì „Éâ„Ç≠„Éâ„Ç≠„ÅåÊ≠¢„Åæ„Çâ„Å™„ÅÑ</li>
                <li onclick="alert('„Äê„Ç∞„É™„ÉÉ„Éó„Çí„ÇÜ„Çã„ÇÅ„Çã„Äë\n\n1. „ÇØ„É©„Éñ„ÇíÁü≠„ÅèÊåÅ„Å§\n2. ÁîüÂçµ„ÇíÊåÅ„Å§„Åè„Çâ„ÅÑÂÑ™„Åó„ÅèÊè°„Çã\n3. ÂçäÂàÜ„ÅÆÂäõ„ÅßÊåØ„Çã')">üèåÔ∏è‚Äç‚ôÇÔ∏è „ÉÅ„Éß„É≠„Éª„ÉÄ„Éï„É™„ÅåÈÄ£Áô∫</li>
                <li onclick="alert('„Äê„É™„Ç∫„É†„Å†„ÅëËÄÉ„Åà„Çã„Äë\n\n„Äå„ÉÅ„É£„Éº„Éª„Ç∑„É•„Éº„Éª„É°„É≥„Äç\n„Åæ„Åü„ÅØ\n„Äå„Ç§„ÉÅ„Éª„Éã„Éª„Çµ„Éº„É≥„Äç\n\n„É™„Ç∫„É†„Çà„ÅèÊåØ„Çã„Åì„Å®„Å†„Åë„Å´ÈõÜ‰∏≠ÔºÅ')">üò´ „Å©„ÅÜÊåØ„Çå„Å∞„ÅÑ„ÅÑ„ÅãÂøò„Çå„Åü</li>
                <li onclick="alert('„Äê„Çø„Éº„Ç≤„ÉÉ„Éà„ÇíÂ§ß„Åç„Åè„Äë\n\n„Éî„É≥„Åß„ÅØ„Å™„Åè„Äå„Ç∞„É™„Éº„É≥„Çª„É≥„Çø„Éº„Äç„ÇÑ„ÄåÂ∫É„ÅÑÂ†¥ÊâÄ„Äç„ÇíÁãô„ÅÜ„ÄÇ\n\nÂÆâÂÖ®Á¨¨‰∏Ä„Åß„ÅÑ„Åç„Åæ„Åó„Çá„ÅÜ„ÄÇ')">üå≥ „Éà„É©„Éñ„É´„Ç∑„Éß„ÉÉ„Éà</li>
            </ul>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="app.closeModal('settingsModal')">√ó</button>
            <div class="modal-header">Ë®≠ÂÆö</div>
            
            <div class="settings-section">
                <span class="settings-label">ÊñáÂ≠ó„ÅÆÂ§ß„Åç„Åï</span>
                <div class="size-btns">
                    <button class="size-btn" data-setsize="medium" onclick="app.setFontSize('medium')">Ê®ôÊ∫ñ</button>
                    <button class="size-btn" data-setsize="large" onclick="app.setFontSize('large')">Â§ß</button>
                    <button class="size-btn" data-setsize="extra" onclick="app.setFontSize('extra')">ÁâπÂ§ß</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="theme-switch-row">
                    <span class="settings-label" style="margin:0;">„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÔºàÂ§úÁî®Ôºâ</span>
                    <input type="checkbox" id="themeSwitch" onchange="app.toggleTheme(this.checked)" style="transform:scale(1.5);">
                </div>
            </div>

            <div class="settings-section" style="border-top:1px solid var(--border-color); padding-top:16px;">
                <span class="settings-label">„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±ÔºàÈÄ£Êê∫Áî®Ôºâ</span>
                <input type="text" id="settingNick" class="settings-input" placeholder="„ÅäÂêçÂâçÔºàLINEÁΩ≤ÂêçÁî®Ôºâ">
                <input type="email" id="settingEmail" class="settings-input" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÔºàÊéß„ÅàÁî®Ôºâ">
                <p class="settings-note">‚ÄªÂÖ•ÂäõÂÜÖÂÆπ„ÅØÁ´ØÊú´ÂÜÖ„Å´‰øùÂ≠ò„Åï„Çå„ÄÅÂÖ±ÊúâÊôÇ„ÅÆÁΩ≤Âêç„Å™„Å©„Å´‰ΩøÁî®„Åï„Çå„Åæ„Åô„ÄÇÂ§ñÈÉ®„Å´„ÅØÈÄÅ‰ø°„Åï„Çå„Åæ„Åõ„Çì„ÄÇ</p>
                <button class="btn-save" onclick="app.saveSettings()">Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åô„Çã</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="app.closeModal('helpModal')">√ó</button>
            <div class="modal-header">„Åì„ÅÆ„Ç¢„Éó„É™„ÅÆ‰Ωø„ÅÑÊñπ</div>
            
            <ul class="help-list">
                <li class="help-item">
                    <div class="help-icon">üéØ</div>
                    <div class="help-text">
                        <h4>ÁõÆÁöÑ</h4>
                        <p>„ÅÇ„Å™„Åü„ÅÆ„Ç¥„É´„Éï„ÅÆÊÇ©„Åø„Çí1ÂàÜ„ÅßË®∫Êñ≠„Åó„ÄÅ‰ªä„Åô„Åê„ÇÑ„Çã„Åπ„ÅçËß£Ê±∫Á≠ñ„Çí„Ç¢„Éâ„Éê„Ç§„Çπ„Åó„Åæ„Åô„ÄÇ</p>
                    </div>
                </li>
                <li class="help-item">
                    <div class="help-icon">1Ô∏è‚É£</div>
                    <div class="help-text">
                        <h4>ÊÇ©„Åø„ÇíÈÅ∏„Å∂</h4>
                        <p>„Äå„Çπ„É©„Ç§„Çπ„Äç„Äå„ÉÄ„Éï„É™„Äç„Å™„Å©„ÄÅ‰ªä‰∏ÄÁï™Âõ∞„Å£„Å¶„ÅÑ„ÇãÁóáÁä∂„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    </div>
                </li>
                <li class="help-item">
                    <div class="help-icon">2Ô∏è‚É£</div>
                    <div class="help-text">
                        <h4>Áä∂Ê≥Å„ÇíÈÅ∏„Å∂</h4>
                        <p>„Äå‰ΩøÁî®„ÇØ„É©„Éñ„Äç„ÇÑ„ÄåÂ†¥ÊâÄÔºàÁ∑¥ÁøíÂ†¥/„Ç≥„Éº„ÇπÔºâ„Äç„ÇíÈÅ∏„Å∂„Å®„ÄÅÁä∂Ê≥Å„Å´Âêà„Å£„ÅüÂä©Ë®Ä„Å´„Å™„Çä„Åæ„Åô„ÄÇ</p>
                    </div>
                </li>
                <li class="help-item">
                    <div class="help-icon">3Ô∏è‚É£</div>
                    <div class="help-text">
                        <h4>Âá¶ÊñπÁÆã„ÇíË¶ã„Çã</h4>
                        <p>„ÇÑ„Çã„Åπ„Åç3„Å§„ÅÆ„Éù„Ç§„É≥„Éà„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇLINE„ÅßÈÄÅ„Å£„Åü„Çä„ÄÅÂ±•Ê≠¥„Å´ÊÆã„Åô„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ</p>
                    </div>
                </li>
            </ul>
            <button class="btn-next" onclick="app.closeModal('helpModal')">Èñâ„Åò„Çã</button>
        </div>
    </div>

</div>

<script>
    /* --- Data Definition --- */
    const PROBLEMS = [
        { id: 'slice', label: 'Âè≥„Éó„ÉÉ„Ç∑„É•\n„Çπ„É©„Ç§„Çπ', icon: 'üçå' },
        { id: 'hook', label: 'Â∑¶Âºï„Å£„Åã„Åë\n„ÉÅ„Éº„Éî„É≥', icon: 'ü¶Ü' },
        { id: 'top', label: '„Éà„ÉÉ„Éó\n„ÉÅ„Éß„É≠', icon: '‚¨ÜÔ∏è' },
        { id: 'duff', label: '„ÉÄ„Éï„É™\nÈ£õ„Å∞„Å™„ÅÑ', icon: '‚õèÔ∏è' },
        { id: 'contact', label: 'ËäØ„Å´\nÂΩì„Åü„Çâ„Å™„ÅÑ', icon: 'üí•' },
        { id: 'distance', label: 'È£õË∑ùÈõ¢„Åå\nËêΩ„Å°„Åü', icon: 'üìâ' },
        { id: 'start', label: 'Êúù„Ç§„ÉÅ„ÅÆ\n‰∏çÂÆâ', icon: 'ü•∂' },
        { id: 'collapse', label: 'ÂæåÂçä\nÂ¥©„Çå„Çã', icon: 'üèöÔ∏è' }
    ];

    const ADVICE_DB = {
        'slice': {
            title: 'ËÉå‰∏≠„Çí„Çø„Éº„Ç≤„ÉÉ„Éà„Å´Âêë„ÅëÁ∂ö„Åë„Çã',
            cause: '‰Ωì„ÅåÊó©„ÅèÈñã„Åç„ÄÅ„ÇØ„É©„Éñ„ÅåÈÅÖ„Çå„Å¶ÂÖ•„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
            todos: [
                'Âè≥Ë∂≥„ÇíÂçäÊ≠©Âæå„Çç„Å´Âºï„ÅÑ„Å¶Êßã„Åà„Çã',
                '„Ç§„É≥„Éë„ÇØ„Éà„Åæ„ÅßËÉ∏„ÇíÂè≥„Å´Âêë„Åë„ÇãÊÑèË≠ò',
                '„Éï„Ç£„Éã„ÉÉ„Ç∑„É•„Åæ„Åß‰∏ÄÊ∞ó„Å´ÊåØ„ÇäÂàá„Çã'
            ],
            ng: '„Éú„Éº„É´„ÇíÂΩì„Å¶„Å´„ÅÑ„ÅèÔºàÊâãÊâì„Å°„Å´„Å™„ÇãÔºâ',
            routine: ['Á¥†ÊåØ„Çä„ÅßÈ¢®Âàá„ÇäÈü≥„Çí„ÄåÂ∑¶ËÄ≥„Äç„ÅßËÅû„Åè', 'Ê∑±ÂëºÂê∏„Çí‰∏ÄÂõû', 'ÁõÆÊ®ô„ÅÆ„ÄåÂ∑¶Á´Ø„Äç„ÇíË¶ã„Å¶Êâì„Å§']
        },
        'hook': {
            title: '‰Ωì„ÅÆÂõûËª¢„ÇíÊ≠¢„ÇÅ„Åö„Å´ÊåØ„ÇäÊäú„Åè',
            cause: 'Êâã„ÅåËøî„Çä„Åô„Åé„Åü„Çä„ÄÅÂõûËª¢„ÅåÊ≠¢„Åæ„Å£„Å¶Êâã„Å†„ÅëÂãï„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
            todos: [
                '„Ç∞„É™„ÉÉ„Éó„ÇíÂ∞ë„Åó„Ç¶„Ç£„Éº„ÇØÔºàÂ∑¶Âõû„ÅóÔºâ„Å´',
                '„Éú„Éº„É´„ÅÆ‰ΩçÁΩÆ„Çí„Éú„Éº„É´ÂçäÂÄã„ÄåÂè≥„Äç„Å∏',
                '„Åä„Éò„ÇΩ„ÇíÁõÆÊ®ô„Å´Âêë„Åë„Çã„Åæ„ÅßÂõû„ÅóÂàá„Çã'
            ],
            ng: 'Âè≥ËÇ©„Çí‰∏ã„Åí„Å¶„Åô„Åè„ÅÑ‰∏ä„Åí„Çã',
            routine: ['„Ç∞„É™„ÉÉ„ÉóÂúß„Çí5Ââ≤„Å´Á∑©„ÇÅ„Çã', '„Éï„Ç©„É≠„Éº„ÅÆÂΩ¢„Çí„Ç§„É°„Éº„Ç∏', '„É™„Ç∫„É†„Å†„ÅëËÄÉ„Åà„Å¶ÊåØ„Çã']
        },
        'top': {
            title: '„ÄåËÜù„ÅÆÈ´ò„Åï„Äç„Çí„Ç≠„Éº„Éó„Åô„Çã',
            cause: '„Ç§„É≥„Éë„ÇØ„ÉàÂâç„Å´‰∏ä‰Ωì„ÅåËµ∑„Åç‰∏ä„Åå„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
            todos: [
                '„Ç¢„Éâ„É¨„Çπ„ÅßËÜù„ÇíËªΩ„ÅèÊõ≤„ÅíÁõ¥„Åô',
                '„Éú„Éº„É´„Åß„ÅØ„Å™„Åè„Äå„Éú„Éº„É´„ÅÆËµ§ÈÅì„Äç„ÇíË¶ã„Çã',
                '„Ç§„É≥„Éë„ÇØ„ÉàÂæå„ÇÇËäù„ÇíË¶ã„ÇãÊÑèË≠ò'
            ],
            ng: '„Éú„Éº„É´„Çí‰∏ä„Åí„Çà„ÅÜ„Å®„Åô„Çã',
            routine: ['ÁõÆÁ∑ö„Çí‰Ωé„Åè‰øù„Å§', 'Ë∂≥Ë£è„ÅÆÈáçÂøÉ„ÇíÊÑü„Åò„Çã', '7Ââ≤„ÅÆÂäõ„Åß„Ç≥„É≥„Éë„ÇØ„Éà„Å´']
        },
        'duff': {
            title: 'Â∑¶Ë∂≥‰ΩìÈáç„Åß„Ç§„É≥„Éë„ÇØ„Éà',
            cause: 'Âè≥Ë∂≥„Å´‰ΩìÈáç„ÅåÊÆã„Çä„ÄÅÊâãÂâç„ÇíÂè©„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
            todos: [
                'ÊúÄÂàù„Åã„Çâ„ÄåÂ∑¶Ë∂≥6ÔºöÂè≥Ë∂≥4„Äç„ÅßÊßã„Åà„Çã',
                '„Éú„Éº„É´„Çí„ÄåÁõ¥Êé•„Äç„ÇØ„É™„Éº„É≥„Å´Êâì„Å§ÊÑèË≠ò',
                'Âè≥Ë∏µ„ÇíÊó©„ÇÅ„Å´Âú∞Èù¢„Åã„ÇâÊµÆ„Åã„Åõ„Çã'
            ],
            ng: '„Éú„Éº„É´„ÇíÈï∑„ÅèË¶ã„Åô„Åé„Çã',
            routine: ['Â∑¶Ë∂≥„ÇíË∏è„ÅøËæº„ÇÄÁ¥†ÊåØ„Çä', '„Éú„Éº„É´„ÅÆÂ∑¶ÂÅ¥„ÇíË¶ã„Çã', '„Éï„Ç£„Éã„ÉÉ„Ç∑„É•„Åß3ÁßíÊ≠¢„Åæ„Çã']
        },
        'contact': {
            title: 'Â§ßÊåØ„ÇäÁ¶ÅÊ≠¢„ÄÅ„Éè„Éº„Éï„Çπ„Ç§„É≥„Ç∞',
            cause: '„Çπ„Ç§„É≥„Ç∞Ëª∏„ÅåÂ∑¶Âè≥‰∏ä‰∏ã„Å´„Éñ„É¨„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
            todos: [
                '„Çπ„Çø„É≥„ÇπÂπÖ„ÇíÈù¥‰∏ÄË∂≥ÂàÜÁã≠„Åè„Åô„Çã',
                '„Äå9ÊôÇ„Äú3ÊôÇ„Äç„ÅÆÊåØ„ÇäÂπÖ„ÅßÊâì„Å§',
                '„Ç∞„É™„ÉÉ„Éó„ÇíÁü≠„ÅèÊåÅ„Å§'
            ],
            ng: '„Éï„É´„Çπ„Ç§„É≥„Ç∞„ÅßÈ£õ„Å∞„Åù„ÅÜ„Å®„Åô„Çã',
            routine: ['ÈÄ£Á∂öÁ¥†ÊåØ„Çä„ÅßËª∏„ÇíÊÑü„Åò„Çã', 'Âäõ„ÇíÊäú„ÅÑ„Å¶ËÑ±Âäõ', 'ÁúüËäØ„Å´ÂΩì„Å¶„ÇãÈü≥„Å†„ÅëÊÉ≥ÂÉè']
        },
        'distance': {
            title: '‰ΩìÂÖ®‰Ωì„Çí‰Ωø„Å£„Åü„Å≠„Åò„ÇåÊàª„Åó',
            cause: 'ÊâãÂÖà„Å†„Åë„ÅßÊåØ„Å£„Å¶„Åä„Çä„ÄÅ‰ΩìÂππ„Åå‰Ωø„Åà„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ',
            todos: [
                '„Éê„ÉÉ„ÇØ„Çπ„Ç§„É≥„Ç∞„ÅßÂ∑¶ËÇ©„ÇíÈ°é„ÅÆ‰∏ã„Å´ÂÖ•„Çå„Çã',
                'Âàá„ÇäËøî„Åó„Åß„Äå‰∏ãÂçäË∫´„Äç„Åã„ÇâÂßãÂãï„Åô„Çã',
                '„Éï„Ç£„Éã„ÉÉ„Ç∑„É•„ÇíÂ§ß„Åç„ÅèÂèñ„Çã'
            ],
            ng: 'ËÖïÂäõ„Å†„Åë„ÅßÂº∑„ÅèÂè©„Åè',
            routine: ['Ê∑±„ÅÑÊçªËª¢„ÇíÁ¢∫Ë™ç„Åô„ÇãÁ¥†ÊåØ„Çä', 'Ë∂≥„ÅÆÊåá„ÅßÂú∞Èù¢„ÇíÊé¥„ÇÄ', '„ÇÜ„Å£„Åü„ÇäÂ§ß„Åç„Å™„É™„Ç∫„É†']
        },
        'start': {
            title: '6Ââ≤„ÅÆÂäõ„Åß„Éï„Çß„Ç¢„Ç¶„Çß„Ç§Áúü„Çì‰∏≠„Å∏',
            cause: 'Á∑äÂºµ„Åß‰Ωì„ÅåÁ°¨„Åè„Å™„Çä„ÄÅ„É™„Ç∫„É†„ÅåÊó©„Åè„Å™„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
            todos: [
                '„ÇÜ„Å£„Åè„ÇäÊÅØ„ÇíÂêê„ÅÑ„Å¶„Åã„ÇâÊßã„Åà„Çã',
                '„ÄåÂΩì„Å¶„Çã„Å†„Åë„Äç„ÅÆ„Å§„ÇÇ„Çä„ÅßÊåØ„Çã',
                '‰∏ÄÁï™ÂæóÊÑè„Å™„ÇØ„É©„Éñ„ÇíÊåÅ„Å§'
            ],
            ng: '„ÄåÈ£õ„Å∞„Åù„ÅÜ„Äç„Äå‰πó„Åõ„Çà„ÅÜ„Äç„Å®Ê¨≤Âºµ„Çã',
            routine: ['Á©∫„ÇíË¶ã‰∏ä„Åí„Å¶Ê∑±ÂëºÂê∏', '„Çø„Éº„Ç≤„ÉÉ„Éà„Çí„Åº„Çì„ÇÑ„ÇäË¶ã„Çã', '„Äå„Ç§„ÉÅ„ÄÅ„Éã„ÄÅ„Çµ„Éº„É≥„Äç„Å®Âî±„Åà„Çã']
        },
        'collapse': {
            title: '‰∏ãÂçäË∫´„ÅÆÂúüÂè∞„Çí‰Ωú„ÇäÁõ¥„Åô',
            cause: 'Áñ≤Âä¥„Åß‰∏ãÂçäË∫´„ÅåÊ≠¢„Åæ„Çä„ÄÅÊâãÊâì„Å°„Å´„Å™„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
            todos: [
                '„Ç¢„Éâ„É¨„Çπ„ÅßË∂≥ËÖ∞„ÅÆË∏è„ÇìÂºµ„Çä„ÇíÂÜçÁ¢∫Ë™ç',
                'Ê∞¥ÂàÜË£úÁµ¶„Å®Ê∑±ÂëºÂê∏',
                'Á¥†ÊåØ„Çä„Çí2Âõû„Åó„Å¶‰Ωì„ÅÆ„Ç≠„É¨„ÇíÊàª„Åô'
            ],
            ng: '‰øÆÊ≠£„Åó„Çà„ÅÜ„Å®„ÅÑ„Çç„ÅÑ„ÇçËÄÉ„Åà„Åô„Åé„Çã',
            routine: ['ËÇ°Èñ¢ÁØÄ„ÇíËªΩ„Åè„Çπ„Éà„É¨„ÉÉ„ÉÅ', '„É™„Ç∫„É†„Çí‰∏ÄÂÆö„Å´„Åô„Çã', '„Äå„Éï„Ç£„Éã„ÉÉ„Ç∑„É•„Äç„Å†„ÅëÊÑèË≠ò']
        }
    };

    /* --- App Logic --- */
    const app = {
        state: {
            step: 1,
            problem: null,
            club: 'driver',
            scene: 'range',
            trend: 'slice',
            history: [],
            fontSize: 'medium', // medium, large, extra
            theme: 'light',
            userNick: '',
            userEmail: ''
        },

        init: function() {
            // Load theme
            const savedTheme = localStorage.getItem('golfCoachTheme') || 'light';
            this.toggleTheme(savedTheme === 'dark');

            // Load font size
            const savedFont = localStorage.getItem('golfCoachFontSize') || 'medium';
            this.setFontSize(savedFont);

            // Load User Info
            this.state.userNick = localStorage.getItem('golfCoachNick') || '';
            this.state.userEmail = localStorage.getItem('golfCoachEmail') || '';
            document.getElementById('settingNick').value = this.state.userNick;
            document.getElementById('settingEmail').value = this.state.userEmail;

            // Load history
            const savedHistory = localStorage.getItem('golfCoachHistory');
            if (savedHistory) {
                this.state.history = JSON.parse(savedHistory);
            }

            // Render Step 1
            this.renderStep1();
            
            // Input changes listeners
            document.querySelectorAll('input[name="club"]').forEach(el => {
                el.addEventListener('change', (e) => this.state.club = e.target.value);
            });
            document.querySelectorAll('input[name="scene"]').forEach(el => {
                el.addEventListener('change', (e) => this.state.scene = e.target.value);
            });
            document.querySelectorAll('input[name="trend"]').forEach(el => {
                el.addEventListener('change', (e) => this.state.trend = e.target.value);
            });
            
            // Place select change logic
            document.getElementById('recordPlaceSelect').addEventListener('change', (e) => {
                const input = document.getElementById('recordPlaceInput');
                if (e.target.value === 'other') {
                    input.classList.remove('hidden');
                    input.focus();
                } else {
                    input.classList.add('hidden');
                }
            });
        },

        /* UI/Modal Control */
        showModal: function(modalId) {
            document.getElementById(modalId).classList.add('open');
        },
        closeModal: function(modalId) {
            document.getElementById(modalId).classList.remove('open');
        },

        /* Settings Logic */
        toggleTheme: function(isDark) {
            const theme = isDark ? 'dark' : 'light';
            this.state.theme = theme;
            document.body.setAttribute('data-theme', theme);
            document.getElementById('themeSwitch').checked = isDark;
            localStorage.setItem('golfCoachTheme', theme);
        },

        setFontSize: function(size) {
            this.state.fontSize = size;
            document.body.setAttribute('data-fontsize', size);
            localStorage.setItem('golfCoachFontSize', size);
            
            // Update active button visual in settings
            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.setsize === size);
            });
        },

        saveSettings: function() {
            const nick = document.getElementById('settingNick').value;
            const email = document.getElementById('settingEmail').value;
            
            this.state.userNick = nick;
            this.state.userEmail = email;
            
            localStorage.setItem('golfCoachNick', nick);
            localStorage.setItem('golfCoachEmail', email);
            
            alert('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
            this.closeModal('settingsModal');
        },

        /* App Steps */
        renderStep1: function() {
            const grid = document.getElementById('problemGrid');
            grid.innerHTML = '';
            PROBLEMS.forEach(p => {
                const btn = document.createElement('div');
                btn.className = 'btn-card';
                btn.innerHTML = `
                    <span class="btn-icon">${p.icon}</span>
                    <span class="btn-label">${p.label.replace(/\n/g, '<br>')}</span>
                `;
                btn.onclick = () => {
                    document.querySelectorAll('.btn-card').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    this.state.problem = p.id;
                    setTimeout(() => this.goToStep(2), 200);
                };
                grid.appendChild(btn);
            });
        },

        goToStep: function(stepNum) {
            // Validation
            if (stepNum === 2 && !this.state.problem) return;
            
            // Update State
            this.state.step = stepNum;

            // UI Update
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step${stepNum}`).classList.remove('hidden');

            // Progress Bar
            document.querySelectorAll('.step-indicator').forEach((el, idx) => {
                el.classList.remove('active', 'completed');
                if (idx + 1 < stepNum) el.classList.add('completed');
                if (idx + 1 === stepNum) el.classList.add('active');
            });

            // Scroll to top
            window.scrollTo(0, 0);

            // If Step 3, Generate Result
            if (stepNum === 3) {
                this.generateResult();
            }
        },

        generateResult: function() {
            const problemId = this.state.problem;
            const baseData = ADVICE_DB[problemId];
            const context = {
                club: this.state.club,
                scene: this.state.scene,
                trend: this.state.trend
            };

            // Copy base data
            let advice = JSON.parse(JSON.stringify(baseData));

            // --- Context Logic ---
            if (context.club === 'driver') {
                advice.todos.push('„ÉÜ„Ç£„Éº„Ç¢„ÉÉ„Éó„ÅÆÈ´ò„Åï„ÇíÁ¢∫Ë™ç');
                if (problemId === 'slice') advice.ng = 'ÊÄù„ÅÑÂàá„ÇäÂè©„Åç„Å´„ÅÑ„Åè';
            } else if (context.club === 'iron') {
                advice.todos.push('„ÉÄ„Ç¶„É≥„Éñ„É≠„ÉºÔºà‰∏ä„Åã„ÇâÔºâ„ÇíÊÑèË≠ò');
            }

            if (context.scene === 'course') {
                advice.title = '„ÄêÁèæÂ†¥ÂØæÂøú„Äë' + advice.title;
                advice.todos = advice.todos.slice(0, 2); 
                advice.todos.push('„Çø„Éº„Ç≤„ÉÉ„Éà„ÇíÂÆâÂÖ®„Å™Â∫É„ÅÑÊñπÂêë„Å∏');
                advice.routine[2] = 'Ê±∫„ÇÅ„Åü„ÇâËø∑„Çè„ÅöÊâì„Å§';
            } else {
                advice.todos.push('„Éè„Éº„Éï„Çπ„Ç§„É≥„Ç∞„ÅßÂΩ¢„ÇíÁ¢∫Ë™ç');
            }

            if (context.trend === 'slice' && problemId === 'distance') {
                advice.cause += ' „Çπ„É©„Ç§„ÇπÂõûËª¢„Åß„É≠„Çπ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ';
            }

            // Render HTML
            const container = document.getElementById('resultContainer');
            container.innerHTML = `
                <div class="result-card">
                    <div class="prescription-title">${advice.title}</div>
                    
                    <div class="cause-section">
                        <strong>‰ªä„ÅÆÁä∂ÊÖãÔºö</strong><br>${advice.cause}
                    </div>

                    <div class="section-header">‰ªä„Åô„Åê„ÇÑ„Çã„Åì„Å®3„Å§</div>
                    <ul class="todo-list">
                        ${advice.todos.slice(0,3).map(t => `
                            <li class="todo-item">
                                <input type="checkbox" class="todo-checkbox">
                                <span class="todo-text">${t}</span>
                            </li>
                        `).join('')}
                    </ul>

                    <div class="section-header">„ÇÑ„Å£„Å¶„ÅØ„ÅÑ„Åë„Å™„ÅÑ (NG)</div>
                    <div class="ng-box">‚ö†Ô∏è ${advice.ng}</div>

                    <div class="section-header">3ÁêÉ„É´„Éº„ÉÜ„Ç£„É≥</div>
                    <div class="routine-list">
                        ${advice.routine.map((r, i) => `
                            <div class="routine-item">
                                <span class="routine-number">${i+1}</span> ${r}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Reset inputs for recording
            document.getElementById('userMemo').value = '';
            document.getElementById('recordPlaceSelect').value = 'Á∑¥ÁøíÂ†¥';
            document.getElementById('recordPlaceInput').classList.add('hidden');
            document.getElementById('recordPlaceInput').value = '';
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recordDate').value = today;
            
            this.currentResult = {
                title: advice.title,
                problemId: problemId,
                todos: advice.todos.slice(0,3)
            };
        },

        saveResult: function() {
            const memo = document.getElementById('userMemo').value;
            const dateVal = document.getElementById('recordDate').value;
            
            // Handle Place
            const selectVal = document.getElementById('recordPlaceSelect').value;
            let placeVal = selectVal;
            if (selectVal === 'other') {
                placeVal = document.getElementById('recordPlaceInput').value || 'Â†¥ÊâÄÊú™ÂÖ•Âäõ';
            }

            const historyItem = {
                ...this.currentResult,
                memo: memo,
                recordDate: dateVal,
                recordPlace: placeVal,
                timestamp: new Date().getTime()
            };

            this.state.history.unshift(historyItem);
            if (this.state.history.length > 20) this.state.history.pop(); // Max 20

            localStorage.setItem('golfCoachHistory', JSON.stringify(this.state.history));
            alert('Â±•Ê≠¥„Å´‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
        },

        shareLine: function() {
            const r = this.currentResult;
            if (!r) return;
            
            const memo = document.getElementById('userMemo').value;
            let text = `„Äê1ÂàÜ„Ç¥„É´„Éï„Ç≥„Éº„ÉÅ„Äë\nÂá¶ÊñπÁÆãÔºö${r.title}\n\n„ÇÑ„Çã„Åπ„Åç„Åì„Å®Ôºö\n${r.todos.map(t=>'„Éª'+t).join('\n')}`;
            if(memo) text += `\n\n„É°„É¢Ôºö\n${memo}`;
            
            // Add user signature if available
            if(this.state.userNick) {
                text += `\n\nFrom: ${this.state.userNick}„Åï„Çì„ÅÆÂÖ±Êúâ`;
            }

            const url = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        },

        toggleHistory: function() {
            this.showModal('historyModal');
            const list = document.getElementById('historyList');
            
            if (this.state.history.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#888;">Â±•Ê≠¥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
            } else {
                list.innerHTML = this.state.history.map(item => {
                    let dateDisplay = item.recordDate || new Date(item.timestamp || Date.now()).toLocaleDateString('ja-JP');
                    let placeDisplay = item.recordPlace ? `<span class="history-place">@${item.recordPlace}</span>` : '';
                    
                    return `
                    <div class="history-item">
                        <div class="history-meta">
                            <span>üìÖ ${dateDisplay}</span>
                            ${placeDisplay}
                        </div>
                        <div class="history-title">${item.title}</div>
                        ${item.memo ? `<div style="font-size:var(--fs-base); color:#666; margin-top:4px;">üìù ${item.memo}</div>` : ''}
                    </div>
                `}).join('');
            }
        },

        clearHistory: function() {
            if(confirm('Êú¨ÂΩì„Å´Â±•Ê≠¥„ÇíÂÖ®„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                this.state.history = [];
                localStorage.removeItem('golfCoachHistory');
                this.toggleHistory(); // Re-render
            }
        },
        
        reset: function() {
            this.state.problem = null;
            this.goToStep(1);
        }
    };

    // Start App
    document.addEventListener('DOMContentLoaded', () => {
        app.init();
    });

</script>
</body>
</html>